# PingCode OpenAPI 集成与代码生成策略

> 目标：明确 SDK 与 PingCode OpenAPI 文档之间的关系，规定生成代码的范围、工具链和变更流程，避免“生成代码把整个项目改挂”的情况。

---

## 1. 角色与分层

- OpenAPI 文档是 PingCode 对外的 HTTP/JSON 协议说明，是 SDK 的上游来源。
- SDK 在此基础上引入两层抽象：
  1. `internal/api`：与 OpenAPI 尽量一一对应的 DTO 层，通常由工具生成；
  2. `sdk/model`：对 Go 开发者友好的领域模型，由人工维护，并通过 mapper 与 `internal/api` 映射。
- Service 层只依赖 `sdk/model` 和 `internal/api`，不直接解析原始 JSON。

---

## 2. 生成代码范围

- 默认仅允许对以下部分进行自动生成：
  - `internal/api/<domain>` 下的 DTO 类型（请求/响应结构体）；
  - 必要时，可以生成部分 mapper 模板或辅助函数，但不得覆盖手写逻辑。
- 以下目录禁止由生成工具直接覆盖：
  - `sdk/model/...`：所有对外数据模型；
  - `sdk/service/...`：业务调用逻辑；
  - `sdk/client.go`、`sdk/config.go` 等。

---

## 3. 工具链与命令约定

- 生成工具应使用 Go 编写或使用通用开源工具，避免依赖私有二进制。
- 生成命令需要固定下来，示意：

```bash
go run ./cmd/openapi-gen \
  --input  docs/reference/openpingcode/*.yaml \
  --output internal/api
```

- 所有生成相关参数必须可配置且有文档说明，禁止只存在于个人本地脚本。

---

## 4. 变更流程

当 OpenAPI 文档发生变更时，流程应包括：

1. 更新 OpenAPI 描述文件（由上游团队维护）。
2. 运行生成工具更新 `internal/api` 代码。
3. 编译并运行测试，确保生成代码本身无语法问题。
4. 根据变更内容评估对 `sdk/model` 和 `sdk/service` 的影响：
   - 新增字段/接口 → 通过新增 model 字段或方法支持；
   - 删除或修改字段/接口 → 需要设计升级策略，避免直接破坏现有调用方。
5. 更新映射逻辑（model ↔ api），并补充/更新测试。
6. 更新相关文档和变更说明（包含是否存在兼容性风险）。

---

## 5. 防漂移与 CI 检查

- CI 中应提供“防漂移”检查：
  - 在 CI 流程中重新运行生成命令；
  - 对比结果与仓库中已有代码是否一致；
  - 若不一致则直接失败，提示开发者更新生成代码。
- 这样可以避免“手改生成代码”或“忘记提交生成结果”的情况。

---

## 6. 与 SDK 契约的关系

- OpenAPI 文档是协议真相来源，但 SDK 对外契约同样需要稳定：
  - 当 OpenAPI 与现有 SDK API 冲突时，优先保证 SDK 已发布版本的兼容性（详见 `api_contract.md`）。
  - 必要时通过新增 SDK API 来支持新行为，而不是直接修改旧 API 的语义。
- `internal/api` 的变更不应直接暴露给 SDK 使用者：
  - 所有行为变化必须通过 `sdk/model` 和 `sdk/service` 的设计体现。

---

## 7. 例外情况与记录

- 若确有特殊原因需要对生成策略或分层方式做出例外调整：
  - 必须在设计评审中记录清楚原因、影响范围和替代方案；
  - 更新本文件，确保后续维护者能够理解当时的决策背景。

