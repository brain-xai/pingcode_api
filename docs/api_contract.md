# PingCode OpenAPI Golang SDK 对外 API 契约规范

> 目标：明确什么算“对外契约”，哪些行为可以改，哪些不能改，避免后期因为不同人对“兼容性”的理解不一致而产生争议。

---

## 1. 范围说明

- 本文档约束的是 **SDK 使用者可见的 API**，包括但不限于：
  - 模块路径：`github.com/brain-xai/pingcode_api/sdk/...`。
  - 导出类型：结构体、接口、别名等。
  - 导出函数与方法：`NewClient`、各领域 Service 方法等。
  - 对外可见的错误类型与错误值。
- 以下内容明确不属于对外契约：
  - `internal/` 目录下的所有实现细节。
  - 生成代码的具体结构，只要对外行为不变。
  - `cmd/` 目录下的调试工具实现细节（除非文档明确标记为对外稳定接口）。

---

## 2. 稳定 API 范围

### 2.1 模块与包路径

- 所有 `sdk/` 下的包路径视为对外稳定命名空间：
  - 例如：`github.com/brain-xai/pingcode_api/sdk/model/project`、`sdk/service/project`。
- 一旦某个包在公开文档或示例中出现，即视为对外可用包，不得随意重命名或移动。

### 2.2 导出类型与字段

- 所有导出类型（首字母大写）一旦发布到稳定版本：
  - 类型名视为契约，禁止重命名。
  - 字段的含义、类型、JSON 标签如有变更，必须按照语义化版本规则处理。
- 新增字段：
  - 允许在 MINOR 版本中新增导出字段，但必须保证旧代码在编译与运行时都不被破坏。

### 2.3 导出函数与方法

- 对外导出的函数/方法一旦进入稳定版本：
  - 函数名固定，不得更改。
  - 参数列表和返回值类型一旦变更，即视为 breaking change。
- 需要调整行为时优先策略：
  - 新增新方法（例如 `CreateProjectV2`），并在旧方法上标记 Deprecated。

### 2.4 错误类型与错误值

- SDK 对外暴露的错误类型（如统一的 `APIError` 或类似类型）属于稳定契约：
  - 字段必须有清晰含义，变更时遵守版本规则。
  - 错误类型的行为（例如是否实现 `errors.Is/As`）必须保持稳定。
- 约定的“语义性错误值”（如 `ErrUnauthorized`、`ErrTimeout`）一旦公开，视为契约的一部分。

---

## 3. Breaking Change 判定标准

以下改动一律视为 **Breaking Change**：

- 删除任意对外导出类型、字段、函数、方法、常量。
- 更改导出字段的类型或语义（例如从 `string` 改为 `int`，或者改变单位）。
- 更改函数或方法的参数列表、返回值类型。
- 更改已有方法或函数的行为，使其在同样的输入下产生不同的关键结果（例如：原本创建资源改成只做校验）。
- 更改错误分类规则，导致调用方基于错误类型的分支逻辑失效。

以下改动 **不视为 Breaking Change**（前提是行为不变）：

- 增加新的导出类型、方法、字段（在调用方不需要修改现有代码的前提下）。
- 修正文档、注释、拼写错误。
- 优化内部实现（包括 `internal/` 目录）而不改变对外行为。

---

## 4. API 演进策略

### 4.1 新功能添加

- 新功能应通过新增类型/方法的方式加入现有包结构，避免修改已有 API 的语义。
- 若新功能是已有功能的严格超集：
  - 可以提供 `XxxV2`、`XxxWithOptions` 等新方法；
  - 在文档中引导用户迁移到新方法。

### 4.2 功能废弃（Deprecation）

- 当需要弃用某个 API 时，必须：
  - 在注释中使用 `Deprecated:` 说明，并给出替代方案；
  - 在 CHANGELOG 中记录废弃信息；
  - 至少在一个 MAJOR 版本周期内保留该 API，避免立即移除。

### 4.3 API 删除

- 仅在发布新的 MAJOR 版本时，才允许删除已标记为 Deprecated 且保留了足够时间的 API。
- 删除前必须给出明确的迁移路径和示例。

---

## 5. 文档与示例的一致性

- 所有对外文档（README、参考文档、示例代码）必须与本契约保持一致：
  - 一旦在对外文档中出现的调用方式，即视为被支持的稳定用法。
  - 禁止在文档中出现依赖 `internal/` 或其它内部实现细节的示例。
- 文档更新被视为发版的一部分：
  - 新增/废弃 API 时必须同步更新文档和示例。

---

## 6. 冲突处理与例外

- 当 OpenAPI 文档与现有 SDK 契约发生冲突时：
  - 以 SDK 已发布的对外契约为第一优先级；
  - 通过内部映射和适配层（`internal/api` → `sdk/model`）处理差异；
  - 必要时通过新版本 API 暴露新行为，而不是直接改变旧 API。
- 如确有必须违背以上规则的极端情况：
  - 必须在设计评审中记录例外原因和影响范围；
  - 在发布说明中明确标注为“破坏性变更”。

